var TYPE_NUMBER=5,TYPE_LITERAL=2,TYPE_STRING=3,TYPE_BRACKETS=4,TYPE_OPERATOR=1,TYPE_FUNCTION=6,TYPE_COMMA=7,NEW_SYMBOL_TOKENS={"(":TYPE_BRACKETS,")":TYPE_BRACKETS,"!":1,"<":1,">":1,",":TYPE_COMMA},SYMBOL_TOKENS={"(":TYPE_BRACKETS,")":TYPE_BRACKETS,"!":1,"+":1,"-":1,"*":1,"/":1,"%":1,"<":1,">":1,"==":1,"!=":1,">=":1,"<=":1,"||":1,"&&":1,"===":1,"!==":1,",":TYPE_COMMA},OPERATOR_PRIORITY={"(":20,")":20,"!":16,"*":14,"/":14,"%":14,"+":13,"-":13,"<":11,"<=":11,">":11,">=":11,"==":10,"!=":10,"===":10,"!==":10,"&&":6,"||":5},TOKEN_FN={"!":e=>new Token(!e.pop().token),"*":e=>new Token(e.pop()*e.pop()),"/":e=>{let n=e.pop();return new Token(e.pop()/n)},"%":e=>{let n=e.pop();return new Token(e.pop()%n)},"+":e=>new Token(e.pop()+e.pop()),"-":e=>{let n=e.pop();return new Token(e.pop()-n)},"<":e=>new Token(e.pop()>e.pop()),"<=":e=>new Token(e.pop()>=e.pop()),">":e=>new Token(e.pop()<e.pop()),">=":e=>new Token(e.pop()<=e.pop()),"==":e=>new Token(e.pop().token==e.pop().token),"!=":e=>new Token(e.pop().token!=e.pop().token),"===":e=>new Token(e.pop().token==e.pop().token),"!==":e=>new Token(e.pop().token!=e.pop().token),"&&":e=>new Token(e.pop().token&&e.pop().token),"||":e=>new Token(e.pop().token||e.pop().token),tag:e=>new Token(outer_tag(e.pop().token))};function Token(e,n){void 0===e&&(e=current_token),this.token=e,void 0===n&&(n=TYPE_NUMBER),this.type=n,n==TYPE_OPERATOR&&(this.priority=OPERATOR_PRIORITY[e]||999),TOKEN_FN[e]&&(this.fn=TOKEN_FN[e])}function MakeTokens(e){let n=[],o="",t=0;function T(){t==TYPE_NUMBER?o-=0:t==TYPE_STRING?o=o.substring(1,o.length):t==TYPE_LITERAL?"true"===o?(o=!0,t=TYPE_NUMBER):"false"===o?(o=!1,t=TYPE_NUMBER):TOKEN_FN[o]&&(t=TYPE_FUNCTION):t==TYPE_OPERATOR&&SYMBOL_TOKENS[o]&&(t=SYMBOL_TOKENS[o]),n.push(new Token(o,t)),o=""}for(let n=0;n<e.length;n++){let p=e[n];if(" "==p)""!==o&&T();else if(0==t)o+=p,"("==p||")"==p?T():t=p.match(/[0-9.]/)?TYPE_NUMBER:p.match(/[_a-zA-Zа-яА-ЯёЁ]/)?TYPE_LITERAL:p.match(/['"`]/)?TYPE_STRING:TYPE_OPERATOR;else if(t==TYPE_NUMBER)p.match(/[0-9.]/)?o+=p:(T(),n--);else if(t==TYPE_LITERAL)p.match(/[_0-9a-zA-Zа-яА-ЯёЁ]/)?o+=p:(T(),n--);else if(t==TYPE_STRING){p==o[0]&&"\\"!=o[o.length-1]?T():o+=p}else t==TYPE_OPERATOR&&(p.match(/[_0-9a-zA-Zа-яА-ЯёЁ'"`]/)?(T(),n--):NEW_SYMBOL_TOKENS[p]?(T(),n--):o+=p);""===o&&(t=0)}return""!==o&&T(),n}function MakeRPN(e){let n=[],o=[];for(let t=0;t<e.length;t++){let T=e[t],p=T.type;if(p==TYPE_NUMBER||p==TYPE_LITERAL||p==TYPE_STRING)n.push(T);else if(p==TYPE_FUNCTION)o.push(T);else if(p==TYPE_COMMA)for(;;){if(!o.length){console.warn("Missing '(' or ','");break}if("("==o.peek())break;n.push(o.pop())}else if(p==TYPE_OPERATOR){for(;0!==o.length;){let e=o.peek();if("("==e||e.type!=TYPE_OPERATOR)break;if(T.priority>e.priority)break;n.push(o.pop())}o.push(T)}else if("("==T)o.push(T);else if(")"==T){for(;o.length>0&&"("!=o.peek();)n.push(o.pop());0===o.length&&console.warn("Missing '('"),o.pop(),o.length&&o.peek().type==TYPE_FUNCTION&&n.push(o.pop())}else console.warn("Unknown token type:",p)}for(;o.length;){let e=o.pop();e.type==TYPE_BRACKETS?console.warn("Unexpected bracket"):n.push(e)}return n}function CalcRPN(e,n){let o=[];return e.forEach(e=>{let t=e.type;if(t==TYPE_NUMBER||t==TYPE_STRING)o.push(e);else if(t==TYPE_LITERAL){let t=n[e.token];if(void 0===t)console.warn("Unknown variable:",e);else{let e;"function"==typeof t?(e=new Token(t.name,TYPE_FUNCTION),t.count?e.fn=function(e){return new Token(t(...e.splice(e.length-t.count)))}:e.fn=t):e=new Token(t,TYPE_NUMBER),o.push(e)}}else if(t==TYPE_OPERATOR||t==TYPE_FUNCTION){let n=e.fn(o);o.push(n)}else console.warn("Can't process token, bad type:",e)}),1!=o.length&&console.warn("Final RPN stack len:",o.length,o),o[0].token}function EvalLite(e,n){return CalcRPN([...MakeRPN(MakeTokens(e))],n)}Array.prototype.peek=function(){return this.slice(-1)[0]},Token.prototype.toString=function(){return this.token},Token.prototype.valueOf=function(){return this.token},eval_lite=EvalLite,eval.lite=EvalLite;